{"createdAt":"2025-10-02T02:41:38.233Z","updatedAt":"2025-10-22T16:49:59.514Z","id":"gNoVMR6BIf8n7PN3","name":"[IA PARA MEDICOS] RESPONDE USUÁRIO","active":false,"isArchived":false,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"0985904e-7d4e-4fba-ae26-2c44200855e1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"52aaf749-fe4f-44e4-880e-15b2bfc027f1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"chat","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"e3e43b4d-d2a5-4418-986a-f7f80ec935b9"}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"bebd0032-c10e-4b58-9d92-e9c5476bb88b","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"=audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"}]},"options":{}},"id":"40915ea6-7a02-4b56-8c07-80ebc0a6b8fb","name":"Switch3","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-672,1584]},{"parameters":{"operation":"binaryToPropery","options":{}},"id":"0e760bed-cbb0-4684-8c78-b84520a31b12","name":"Audio-Base64-Extract from File","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[352,2336]},{"parameters":{"content":"# Resposta em Áudio","height":80,"width":376,"color":5},"id":"40487284-fc0c-4f76-b074-0d1bfd9f35d7","name":"Sticky Note25","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2160]},{"parameters":{"jsCode":"// Obtém o primeiro item do fluxo\nconst item = $input.first();\n\n// Garante que há dados na entrada\nif (!item || !item.json || !$('When Executed by Another Workflow').first().json.output) {\n  throw new Error(\"A chave 'output' não foi encontrada no JSON de entrada.\");\n}\n\n// Processa o texto removendo todas as quebras de linha e emojis\nconst textoEntrada = $('When Executed by Another Workflow').first().json.output; // Use a chave correta para pegar o texto de entrada\n\n// Remove quebras de linha (\\n)\nlet textoProcessado = textoEntrada.replace(/\\n/g, \"\");\n\n// Remove emojis\ntextoProcessado = textoProcessado.replace(\n  /[\\u{1F600}-\\u{1F64F}]|[\\u{1F300}-\\u{1F5FF}]|[\\u{1F680}-\\u{1F6FF}]|[\\u{1F700}-\\u{1F77F}]|[\\u{1F780}-\\u{1F7FF}]|[\\u{1F800}-\\u{1F8FF}]|[\\u{1F900}-\\u{1F9FF}]|[\\u{1FA00}-\\u{1FA6F}]|[\\u{1FA70}-\\u{1FAFF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]|[\\u{FE00}-\\u{FE0F}]|[\\u{1F1E0}-\\u{1F1FF}]/gu,\n  \"\"\n);\n\n// Retorna o resultado\nreturn {\n  textoOriginal: textoEntrada,\n  textoSemQuebrasNemEmojis: textoProcessado,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,2336],"id":"863c2d09-4859-45e8-915f-8c43f706a552","name":"Formata Mensagem para Áudio"},{"parameters":{"workflowInputs":{"values":[{"name":"messageType"},{"name":"telefone"},{"name":"output"},{"name":"session_id"},{"name":"id_message"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1792,608],"id":"1552232b-27f0-4856-8a6d-37b6f9bb5c47","name":"When Executed by Another Workflow"},{"parameters":{"options":{}},"id":"ef711853-6751-4a91-885f-7e8d126be541","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-1136,608]},{"parameters":{"amount":2},"id":"fe79da47-64ed-45b6-a445-eb311f218a25","name":"Wait1","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1136,480],"webhookId":"069143e9-1ca0-42d0-ae36-a57c428d8cba"},{"parameters":{"assignments":{"assignments":[{"id":"e5658d52-0569-4cdf-8d18-39008eeabd2d","name":"status","value":"success","type":"string"}]},"options":{}},"id":"c48bbfd6-846c-4fb5-b926-8d5ef37b4f42","name":"retornar sucesso1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[32,-16],"executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ae76fc1f-0806-4811-b7df-da9f7aca756a","leftValue":"={{ $json.content }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"3b8e096b-3a97-4f9f-9e2c-14ee56928fa7","name":"Filter","type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-1376,608]},{"parameters":{"jsCode":"// pega a saída do nó anterior\nconst text = $('When Executed by Another Workflow').first().json.output;\nconst result = [];\nlet messageCounter = 1; // Contador para as mensagens\n\n// 1) Separa em “seções” por dupla quebra de linha\nconst sections = text.split(/\\n\\s*\\n/);\n\nsections.forEach(section => {\n  const lines = section.split('\\n');\n  let buffer = [];\n\n  lines.forEach(line => {\n    // detecta imagem (markdown com {type})\n    const imageMatch = line.match(/!\\[(.*?)\\]\\((.*?)\\)\\{(.*?)\\}/);\n    if (imageMatch) {\n      // processa texto acumulado antes da imagem\n      if (buffer.length) {\n        processText(buffer.join('\\n').trim());\n        buffer = [];\n      }\n      result.push({\n        type: imageMatch[3],\n        description: imageMatch[1],\n        content: imageMatch[2]\n      });\n    } else {\n      buffer.push(line);\n    }\n  });\n\n  // processa o que sobrou no buffer dessa seção\n  if (buffer.length) {\n    processText(buffer.join('\\n').trim());\n  }\n});\n\n\n// 2) Se todo bloco for só linhas de horário (HH:MM), envia tudo junto\nfunction processText(textBlock) {\n  const lines = textBlock.split('\\n').map(l => l.trim());\n  const allHaveTime = lines.length > 1 && lines.every(l => /\\d{2}:\\d{2}/.test(l));\n  if (allHaveTime) {\n    result.push({\n      type: \"text\",\n      description: \"text\",\n      content: lines.join('\\n')\n    });\n    return;\n  }\n  // senão, quebra em frases pela pontuação\n  finalizeText(textBlock);\n}\n\n\n// 3) fatiamento “normal” de texto: quebra em [? ! ; :] mas não entre dígitos (evita fatiar “09:00”)\nfunction finalizeText(text) {\n  const regex = /(?<!\\d)([?!])(?!\\d|\\s*[\\p{Emoji_Presentation}\\p{Extended_Pictographic}])/gu;\n  let parts = [],\n    lastIndex = 0;\n\n  for (const m of text.matchAll(regex)) {\n    const idx = m.index + 1;\n    parts.push(text.slice(lastIndex, idx).trim());\n    lastIndex = idx;\n  }\n  if (lastIndex < text.length) {\n    parts.push(text.slice(lastIndex).trim());\n  }\n\n  parts.forEach(fragment => {\n    if (fragment) {\n      result.push({\n        type: \"text\",\n        description: \"text\",\n        content: fragment,\n        number: messageCounter++ // Adiciona o número como uma propriedade 'number'\n      });\n    }\n  });\n}\n\n\n// retorna o array pronto\nreturn result;"},"id":"cc7fdf79-9dce-4418-abd6-e456eb6c0992","name":"Code","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1584,608]},{"parameters":{"content":"","height":344,"width":956,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1888,448],"typeVersion":1,"id":"b2f3aa71-ad7d-418c-a506-5dc2658aa93d","name":"Sticky Note"},{"parameters":{"content":"## Recebe a mensagem da IA e Divide ela","height":80,"width":560,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1872,464],"typeVersion":1,"id":"d9bb2965-b7d0-45fb-b61c-e08ad548ab50","name":"Sticky Note1"},{"parameters":{"content":"# Identificar a resposta da IA","height":400,"width":400},"type":"n8n-nodes-base.stickyNote","position":[-816,1440],"typeVersion":1,"id":"4c3de9d6-8b9d-410a-adcb-252aef0e2905","name":"Sticky Note2"},{"parameters":{"content":"# Responder em Imagem","height":400,"width":728,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-208,1712],"typeVersion":1,"id":"50cdfea0-8735-4d65-b8a3-453947f330d5","name":"Sticky Note26"},{"parameters":{"content":"# Responder em Texto Marcado","height":400,"width":728,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-208,1280],"typeVersion":1,"id":"f017721a-4756-4924-b4e7-5c21d1940a9d","name":"Sticky Note27"},{"parameters":{"resource":"messages-api","instanceName":"testeagente","remoteJid":"={{ $('When Executed by Another Workflow').first().json.telefone }}","messageText":"={{ $('Loop Over Items').first().json.content }}","options_message":{"quoted":{"messageQuoted":{"messageId":"={{ $('When Executed by Another Workflow').item.json.id_message }}"}}}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1328,1584],"id":"83c7e6c1-e48a-4427-a960-ea2f933baead","name":"Enviar texto","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}}},{"parameters":{"options_Create_instance":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[64,1872],"id":"a6dbefcd-82f2-4b8c-9ba2-f109dd3850f7","name":"Enviar imagem","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b1b526d1-3225-4a44-bf44-7c21a9131d89","leftValue":"={{ $('Filter').item.json.number }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-144,944],"id":"aba511cc-badb-4ba6-a3ca-d054d45582e2","name":"If"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"0985904e-7d4e-4fba-ae26-2c44200855e1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"52aaf749-fe4f-44e4-880e-15b2bfc027f1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"chat","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"e3e43b4d-d2a5-4418-986a-f7f80ec935b9"}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"}]},"options":{}},"id":"586620d7-c401-4050-a0a3-febbb8953d0a","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3,"position":[144,944]},{"parameters":{"resource":"messages-api","instanceName":"testeagente","remoteJid":"={{ $('When Executed by Another Workflow').first().json.telefone }}","messageText":"={{ $('Loop Over Items').first().json.content }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1328,1456],"id":"02eb7e8a-ba29-442e-b00a-5a37ae1b8d68","name":"Enviar texto1","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}}},{"parameters":{"content":"# Responder sem Marcação","height":416,"width":940,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-208,832],"typeVersion":1,"id":"2b1394ba-019f-4690-b8e9-2efc79dcc696","name":"Sticky Note28"},{"parameters":{"resource":"messages-api","operation":"send-audio","instanceName":"testeagente","remoteJid":"={{ $('When Executed by Another Workflow').item.json.telefone }}","media":"={{ $json.data }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[544,2336],"id":"48b0480b-213b-4d2d-ad3c-92037f1a64a2","name":"Enviar audio","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}}},{"parameters":{"content":"","height":416,"width":972,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-208,2144],"typeVersion":1,"id":"d8e445dd-3ddd-4365-9d2f-77ec81164414","name":"Sticky Note29"},{"parameters":{"content":"# MENSAGEM ENVIADAS","height":304,"width":496,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-160,-112],"typeVersion":1,"id":"00a99908-8bd0-4db3-bf36-adbfaf9ca07d","name":"Sticky Note3"},{"parameters":{"resource":"audio","model":"tts-1-hd","input":"={{ $json.textoSemQuebrasNemEmojis }}","voice":"echo","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[144,2336],"id":"67ad8393-0321-4e5e-92fd-52411d22e58b","name":"Generate audio","credentials":{"openAiApi":{"id":"ScqsAD8O3SwQfUGc","name":"INFRADEV"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-352,688],"id":"7cc300bb-c734-4bb7-a8e9-3c1f29204fda","name":"No Operation, do nothing"},{"parameters":{"operation":"get","key":"={{ $('When Executed by Another Workflow').item.json.telefone }}_block","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1424,1152],"id":"2c82e973-b7f5-4414-be69-fbdd9b31be3c","name":"Redis","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ba001504-2c69-4938-85d4-d31ccf6ef35a","leftValue":"={{ $json.propertyName }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1648,1152],"id":"85f7a8ac-c3d5-4751-9374-fb300bc8fac3","name":"If1"},{"parameters":{"operation":"get","propertyName":"block","key":"={{ $('When Executed by Another Workflow').first().json.telefone }}_block","options":{}},"id":"fdd6fa07-eb96-41f9-92ea-7f1fc3b6f42f","name":"Verifica Atendimento Humano1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-848,848],"credentials":{"redis":{"id":"7HCG3WpFnYjB2DIT","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.block }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Ativa"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3ef0e01c-cc14-4663-bb4d-2905b350c3ab","leftValue":"={{ $json.block }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Desativada"}]},"options":{}},"id":"f6e3afe8-cfb8-45d9-8ae6-b71d8faab5ad","name":"Switch Block","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-608,848]},{"parameters":{"resource":"Chatting","operation":"Send Text","session":"=Agenteteste","chatId":"={{ $('When Executed by Another Workflow').first().json.telefone }}","reply_to":"=","text":"={{ $('Loop Over Items').first().json.content }}","linkPreview":false,"requestOptions":{}},"type":"@devlikeapro/n8n-nodes-waha.WAHA","typeVersion":202502,"position":[432,960],"id":"4b395d50-bc4e-44bf-81cf-6de9a6a37714","name":"Send a text message1","credentials":{"wahaApi":{"id":"7N6Qnba8NbZLvCTo","name":"WAHA - MEDMASTERS"}}},{"parameters":{"resource":"Chatting","operation":"Send Text","session":"=Agenteteste","chatId":"={{ $('When Executed by Another Workflow').first().json.telefone }}","reply_to":"={{ $('When Executed by Another Workflow').item.json.id_message }}","text":"={{ $('Loop Over Items').first().json.content }}","linkPreview":false,"requestOptions":{}},"type":"@devlikeapro/n8n-nodes-waha.WAHA","typeVersion":202502,"position":[112,1456],"id":"6d48db30-4fb0-45ab-98ab-3cf8a944dc11","name":"Send a text message","credentials":{"wahaApi":{"id":"7N6Qnba8NbZLvCTo","name":"WAHA - MEDMASTERS"}}},{"parameters":{"resource":"Chats","operation":"Delete Chat","session":"=DraEduarda","chatId":"=5519981941604","requestOptions":{}},"type":"@devlikeapro/n8n-nodes-waha.WAHA","typeVersion":202502,"position":[944,1168],"id":"1fb59cbd-4f81-42c4-8ffc-b8a1c4345387","name":"Deletes the chat","credentials":{"wahaApi":{"id":"7N6Qnba8NbZLvCTo","name":"WAHA - MEDMASTERS"}}}],"connections":{"Switch3":{"main":[[{"node":"Enviar imagem","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Formata Mensagem para Áudio","type":"main","index":0}],[{"node":"Formata Mensagem para Áudio","type":"main","index":0}]]},"Audio-Base64-Extract from File":{"main":[[{"node":"Enviar audio","type":"main","index":0}]]},"Formata Mensagem para Áudio":{"main":[[{"node":"Generate audio","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Code","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"retornar sucesso1","type":"main","index":0}],[{"node":"Verifica Atendimento Humano1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Code":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Enviar texto":{"main":[[]]},"Enviar imagem":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"If":{"main":[[{"node":"Switch3","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[],[{"node":"Send a text message1","type":"main","index":0}]]},"Enviar texto1":{"main":[[]]},"Enviar audio":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Generate audio":{"main":[[{"node":"Audio-Base64-Extract from File","type":"main","index":0}]]},"Redis":{"main":[[{"node":"If1","type":"main","index":0}]]},"Verifica Atendimento Humano1":{"main":[[{"node":"Switch Block","type":"main","index":0}]]},"Switch Block":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Send a text message1":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Send a text message":{"main":[[{"node":"Wait1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"When Executed by Another Workflow":[{"json":{"messageType":"chat","telefone":"555197519127","output":"Ótimo, Willian! Na Gastro avaliamos refluxo, dor abdominal, azia, intestino e fígado, com médico especializado (RQE) e cuidado individualizado. O atendimento será por convênio ou particular?","session_id":"6a4af981-1003-4465-9e3a-a8b14b85e775","id_message":"3EB056D42653EB266A7C38"}},{"json":{"messageType":"chat","telefone":"555197519127","output":"Entendido, vamos seguir com Gastro. O atendimento será por convênio ou particular?","session_id":"803a8a9a-f43c-46db-a788-1ff463f6192d","id_message":"3EB056D42653EB266A7C38"}},{"json":{"messageType":"chat","telefone":"555197519127","output":"Combinado, seguimos com Gastro. O atendimento será por convênio ou particular?","session_id":"a39047f4-6157-4ba6-8200-5b5e48fed51c","id_message":"3EB056D42653EB266A7C38"}}]},"versionId":"42f50363-7b95-409c-8b3f-dfda0336ff6a","triggerCount":0,"shared":[{"createdAt":"2025-10-02T02:41:38.233Z","updatedAt":"2025-10-02T02:41:38.233Z","role":"workflow:owner","workflowId":"gNoVMR6BIf8n7PN3","projectId":"E1RXJ9dhy40aA4CQ"}],"tags":[]}