{"createdAt":"2025-10-02T02:37:28.801Z","updatedAt":"2025-10-15T20:42:49.210Z","id":"eaf82o3lGrofNrGF","name":"[IA PARA MEDICOS] RECEBE MENSAGEM","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"agenteteste","options":{}},"id":"05b78b10-0b83-489c-91ef-86b2df4100e7","name":"Webhook EVO","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-976,656],"webhookId":"0084a2f2-db35-4cee-afd6-151b6edd0cf9"},{"parameters":{"content":"","height":560,"width":640,"color":4},"type":"n8n-nodes-base.stickyNote","position":[704,432],"typeVersion":1,"id":"e8ec3509-f77f-4686-80a0-76c2787fca7d","name":"Sticky Note42"},{"parameters":{"content":"# Dados","height":80,"width":150,"color":5},"id":"c4ea41d8-5a6e-49b3-a960-f720e1114e60","name":"Sticky Note43","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[720,464]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE dados_cliente (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  telefone TEXT, \n  sessionid TEXT,\n  email TEXT,\n  cpf_cnpj TEXT,\n  asaas_customer_id TEXT,\n  nome TEXT,\n  payments JSONB\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-48,240],"id":"4d6dd2a6-be7f-47dc-9329-7fa64d3c3858","name":"Cria Tabela Dados Cliente","credentials":{"postgres":{"id":"xfu8d5Swurnb9Y4c","name":"[SUPABASE] IA MODELO"}}},{"parameters":{"content":"","height":216,"color":4},"type":"n8n-nodes-base.stickyNote","position":[400,192],"typeVersion":1,"id":"0adf8f61-9fc8-4db3-b200-8971b753fc1c","name":"Sticky Note49"},{"parameters":{"content":"","height":216,"width":230,"color":4},"type":"n8n-nodes-base.stickyNote","position":[144,192],"typeVersion":1,"id":"0592d973-4d57-4bcc-a4f0-5f65c2877090","name":"Sticky Note50"},{"parameters":{"content":"","height":216,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-112,192],"typeVersion":1,"id":"9d883a6c-a1a1-4329-9a43-9b9b905ffe9f","name":"Sticky Note57"},{"parameters":{"operation":"executeQuery","query":"create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text, \n  app text,\n  conversation_id text\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[208,224],"id":"290f9dc9-ffd8-47a1-822a-f6c1ad2ba785","name":"Cria Tabela Chats","credentials":{"postgres":{"id":"xfu8d5Swurnb9Y4c","name":"[SUPABASE] IA MODELO"}}},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  conversation_id TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  data TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[464,240],"id":"abbe5ea2-722b-4da7-ad8a-07a20afe8d14","name":"Cria Tabela Chat_Messages","credentials":{"postgres":{"id":"xfu8d5Swurnb9Y4c","name":"[SUPABASE] IA MODELO"}}},{"parameters":{"content":"","height":560,"width":960,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1168,432],"typeVersion":1,"id":"6fbfad9a-0ae8-4338-88c0-9586f2c2e117","name":"Sticky Note32"},{"parameters":{"content":"# Webhook","height":80,"width":196,"color":5},"id":"111e0a31-752b-4700-a268-c92db299c57f","name":"Sticky Note67","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1152,448]},{"parameters":{"content":"","height":200,"color":4},"type":"n8n-nodes-base.stickyNote","position":[144,-32],"typeVersion":1,"id":"910809cf-4d68-404e-a9b8-cb54bab87c1d","name":"Sticky Note34"},{"parameters":{"content":"","height":560,"width":880,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-192,432],"typeVersion":1,"id":"a718cabd-de58-449f-96ac-db1ebdf61564","name":"Sticky Note29"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.block }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Ativa"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3ef0e01c-cc14-4663-bb4d-2905b350c3ab","leftValue":"={{ $json.block }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Desativada"}]},"options":{}},"id":"b5bcb038-9a12-4093-88e8-498af043e42d","name":"Switch Block","type":"n8n-nodes-base.switch","typeVersion":3,"position":[1616,768]},{"parameters":{"content":"# Pausa para Atendimento Humano por tempo","height":80,"width":816,"color":5},"id":"66dfd150-9887-42d2-a435-8f3305a718bc","name":"Sticky Note51","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-176,448]},{"parameters":{"operation":"get","propertyName":"block","key":"={{ $json.telefone }}_block","options":{}},"id":"141ac71f-b96f-486b-9ead-03a07ba271eb","name":"Verifica Atendimento Humano1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1104,768],"credentials":{"redis":{"id":"7HCG3WpFnYjB2DIT","name":"Redis account"}}},{"parameters":{"operation":"executeQuery","query":"delete from n8n_chat_histories;\ndelete from chats;\ndelete from dados_cliente;\ndelete from chat_messages;\ndelete from chats;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[208,-16],"id":"9bcb1e21-3569-43c9-a5b6-061cfe0db24d","name":"Deleta dados","credentials":{"postgres":{"id":"xfu8d5Swurnb9Y4c","name":"[SUPABASE] IA MODELO"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"d7b42536-638f-4128-b51b-6aa913e9d9bc","leftValue":"={{ $json['Eu?'] }}","rightValue":"DESATIVADA","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA DESATIVADA"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json['Eu?'] }}","rightValue":"ATIVA","operator":{"type":"string","operation":"equals"},"id":"329bbc9a-d6b6-4400-a9c2-f7745979a4ae"}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Ativa"}]},"options":{}},"id":"e94d65db-3b74-4a65-8778-e07dde6ae630","name":"verificar se o humano mandou mensagem","type":"n8n-nodes-base.switch","typeVersion":3,"position":[800,656]},{"parameters":{"operation":"set","key":"={{ $json.telefone }}_block","value":"true","keyType":"string","expire":true,"ttl":86400},"id":"bb7ced99-7aa3-413f-9e36-7c410a4446fb","name":"PARAR a IA","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1104,576],"alwaysOutputData":true,"credentials":{"redis":{"id":"7HCG3WpFnYjB2DIT","name":"Redis account"}}},{"parameters":{"content":"# Gravar mensagem EU","height":280,"width":640},"type":"n8n-nodes-base.stickyNote","position":[704,96],"typeVersion":1,"id":"d2432e1a-b2b9-4cdf-8afd-265d93360572","name":"Sticky Note1"},{"parameters":{"content":"# Gravar mensagem USER","height":280,"width":640},"type":"n8n-nodes-base.stickyNote","position":[704,1024],"typeVersion":1,"id":"a2063a78-86f8-4ce7-9521-06fba74ea400","name":"Sticky Note5"},{"parameters":{"operation":"executeQuery","query":"delete from n8n_chat_histories;\ndelete from chats;\ndelete from dados_cliente;\ndelete from chat_messages;\ndelete from chats;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[512,-16],"id":"05d43dbf-c11f-464e-bc76-9a6ff0516a93","name":"Deleta dados1","credentials":{"postgres":{"id":"N7xUu7OKyWdyBiSV","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9db97d3f-cf5b-49ab-956b-efbfa55c7e2a","leftValue":"={{ $('Webhook EVO').first().json.body.payload.from }}","rightValue":"@g.us","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-640,656],"id":"03c7a34f-2a01-4276-9b5c-d396b1369935","name":"verificar se é grupo1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1c41bcaf-df61-4d9d-99c8-49226a5c3378","leftValue":"={{ $json.body.data.key.remoteJid }}","rightValue":"@lid","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-160,672],"id":"a7e01647-6329-469d-bb1f-b60398a2577e","name":"If1"},{"parameters":{"workflowId":{"__rl":true,"value":"IeyN3wtMjzF2lpzE","mode":"list","cachedResultUrl":"/workflow/IeyN3wtMjzF2lpzE","cachedResultName":"[IA PARA MEDICOS] CADASTRA/CONSULTAR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"id_message":"={{ $('mapeamento de dados').item.json.id_mensagem }}","message":"={{ $('mapeamento de dados').item.json.Conteudo_Mensagem }}","type_message":"={{ $('mapeamento de dados').item.json.Type_menssage }}","telefone":"={{ $('mapeamento de dados').item.json.telefone }}","url_media":"={{ $('mapeamento de dados').item.json.ConteudoURL }}","pushName":"={{ $('mapeamento de dados').item.json.pushName }}","descricao":"={{ $('Webhook EVO').first().json.body.data.message.imageMessage.caption }}","base64_media":"={{ $('Webhook EVO').first().json.body.payload._data.body }}"},"matchingColumns":[],"schema":[{"id":"id_message","displayName":"id_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"type_message","displayName":"type_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"url_media","displayName":"url_media","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"base64_media","displayName":"base64_media","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"pushName","displayName":"pushName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"descricao","displayName":"descricao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1920,752],"id":"cd6c7b67-9979-4b62-aa23-8491bf36537a","name":"CRIAR OU PEGAR SESSION_ID1"},{"parameters":{"assignments":{"assignments":[{"id":"11800d83-ecca-4f9c-a878-a2419db0c8e9","name":"telefone","value":"={{ $('Webhook EVO').first().json.body.payload.from.split('@')[0] }}","type":"string"},{"id":"8f16b1bf-1a3e-4029-8d7a-1bccb919ee43","name":"id_mensagem","value":"={{  $('Webhook EVO').first().json.body.payload._data.id.id }}","type":"string"},{"id":"c33f9527-e661-49e5-8e5e-64f3b430928a","name":"Type_menssage","value":"={{ $('Webhook EVO').item.json.body.payload._data.type }}","type":"string"},{"id":"06eba1c9-cff0-4f68-b6da-6bb0092466b7","name":"Conteudo_Mensagem","value":"={{ $('Webhook EVO').first().json.body.payload.body }}","type":"string"},{"id":"dc3dc59c-90a3-4a45-bea2-de092c91083b","name":"ConteudoURL","value":"={{ $('Webhook EVO').first().json.body.payload.media.url }}","type":"string"},{"id":"8b01a818-a456-476e-bace-adefe2f04eb4","name":"Eu?","value":"={{ $('Webhook EVO').first().json.body.payload.fromMe ? 'DESATIVADA' : 'ATIVA' }}","type":"string"},{"id":"a4b5445f-62f6-48ea-a732-3dbd023982ac","name":"pushName","value":"={{ $('Webhook EVO').first().json.body.payload._data.notifyName }}","type":"string"}]},"options":{}},"id":"c2627a4c-65ed-423d-a7ab-44ea5b6cb0b0","name":"mapeamento de dados","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[512,656]}],"connections":{"Webhook EVO":{"main":[[{"node":"verificar se é grupo1","type":"main","index":0}]]},"Switch Block":{"main":[[{"node":"CRIAR OU PEGAR SESSION_ID1","type":"main","index":0}],[]]},"Verifica Atendimento Humano1":{"main":[[{"node":"Switch Block","type":"main","index":0}]]},"verificar se o humano mandou mensagem":{"main":[[{"node":"PARAR a IA","type":"main","index":0}],[{"node":"Verifica Atendimento Humano1","type":"main","index":0}]]},"PARAR a IA":{"main":[[]]},"Deleta dados":{"main":[[]]},"verificar se é grupo1":{"main":[[],[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"mapeamento de dados","type":"main","index":0}]]},"mapeamento de dados":{"main":[[{"node":"verificar se o humano mandou mensagem","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook EVO":[{"json":{"headers":{"host":"api.infradevcloud.com","user-agent":"WAHA/2025.10.1","content-length":"3034","accept":"application/json, text/plain, */*","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"77.237.235.159","x-forwarded-host":"api.infradevcloud.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"9b272bc18a34","x-real-ip":"77.237.235.159","x-webhook-request-id":"01K7MSKPVSHHAKNA0NP9N5TG1T","x-webhook-timestamp":"1760560798585"},"params":{},"query":{},"body":{"id":"evt_01k7mskpvs73b4pnwf1jca013z","timestamp":1760560798585,"event":"message","session":"Agenteteste","metadata":{},"me":{"id":"5511913987233@c.us","pushName":"INFRADEV"},"payload":{"id":"false_5519981941604@c.us_3B8A3CECDC259D74C5F0","timestamp":1760560797,"from":"5519981941604@c.us","fromMe":false,"source":"app","to":"5511913987233@c.us","body":"oie","hasMedia":false,"media":null,"ack":1,"ackName":"SERVER","vCards":[],"_data":{"id":{"fromMe":false,"remote":"5519981941604@c.us","id":"3B8A3CECDC259D74C5F0","_serialized":"false_5519981941604@c.us_3B8A3CECDC259D74C5F0"},"viewed":false,"body":"oie","type":"chat","t":1760560797,"clientReceivedTsMillis":1760560798367,"notifyName":"Guilherme Barros","from":"5519981941604@c.us","to":"5511913987233@c.us","ack":1,"invis":false,"isNewMsg":true,"star":false,"kicNotified":false,"recvFresh":true,"isFromTemplate":false,"pollInvalidated":false,"isSentCagPollCreation":false,"latestEditMsgKey":null,"latestEditSenderTimestampMs":null,"mentionedJidList":[],"groupMentions":[],"isEventCanceled":false,"eventInvalidated":false,"isVcardOverMmsDocument":false,"isForwarded":false,"isQuestion":false,"questionReplyQuotedMessage":null,"questionResponsesCount":0,"readQuestionResponsesCount":0,"labels":[],"hasReaction":false,"viewMode":"VISIBLE","messageSecret":{"0":2,"1":253,"2":222,"3":107,"4":196,"5":126,"6":83,"7":157,"8":152,"9":232,"10":165,"11":164,"12":10,"13":105,"14":40,"15":0,"16":48,"17":172,"18":33,"19":242,"20":31,"21":85,"22":42,"23":48,"24":81,"25":235,"26":255,"27":182,"28":16,"29":94,"30":197,"31":73},"productHeaderImageRejected":false,"lastPlaybackProgress":0,"isDynamicReplyButtonsMsg":false,"isCarouselCard":false,"parentMsgId":null,"callSilenceReason":null,"isVideoCall":false,"callDuration":null,"callCreator":null,"callParticipants":null,"isCallLink":null,"callLinkToken":null,"isMdHistoryMsg":false,"stickerSentTs":0,"isAvatar":false,"lastUpdateFromServerTs":0,"invokedBotWid":null,"bizBotType":null,"botResponseTargetId":null,"botPluginType":null,"botPluginReferenceIndex":null,"botPluginSearchProvider":null,"botPluginSearchUrl":null,"botPluginSearchQuery":null,"botPluginMaybeParent":false,"botReelPluginThumbnailCdnUrl":null,"botMessageDisclaimerText":null,"botMsgBodyType":null,"reportingTokenInfo":{"reportingToken":{"0":120,"1":194,"2":107,"3":191,"4":19,"5":154,"6":76,"7":221,"8":1,"9":135,"10":39,"11":35,"12":241,"13":252,"14":53,"15":249},"version":2,"reportingTag":{"0":1,"1":12,"2":129,"3":140,"4":84,"5":182,"6":180,"7":3,"8":182,"9":236,"10":184,"11":152,"12":147,"13":246,"14":147,"15":243,"16":226,"17":38,"18":175,"19":197}},"requiresDirectConnection":null,"bizContentPlaceholderType":null,"hostedBizEncStateMismatch":false,"senderOrRecipientAccountTypeHosted":false,"placeholderCreatedWhenAccountIsHosted":false,"galaxyFlowDisabled":false,"groupHistoryBundleMessageKey":null,"groupHistoryBundleMetadata":null,"links":[]}},"engine":"WEBJS","environment":{"version":"2025.10.1","engine":"WEBJS","tier":"PLUS","browser":"/usr/bin/chromium"}},"webhookUrl":"https://api.infradevcloud.com/webhook/agenteteste","executionMode":"production"}}]},"versionId":"adee2e9c-50e0-4872-9748-5362bd8740d7","triggerCount":1,"shared":[{"createdAt":"2025-10-02T02:37:28.801Z","updatedAt":"2025-10-02T02:37:28.801Z","role":"workflow:owner","workflowId":"eaf82o3lGrofNrGF","projectId":"E1RXJ9dhy40aA4CQ"}],"tags":[]}