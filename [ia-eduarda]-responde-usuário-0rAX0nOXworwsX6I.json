{"createdAt":"2025-10-14T11:41:01.289Z","updatedAt":"2025-11-11T20:15:28.554Z","id":"0rAX0nOXworwsX6I","name":"[IA EDUARDA] RESPONDE USU√ÅRIO","active":false,"isArchived":false,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"0985904e-7d4e-4fba-ae26-2c44200855e1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"52aaf749-fe4f-44e4-880e-15b2bfc027f1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"chat","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"e3e43b4d-d2a5-4418-986a-f7f80ec935b9"}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"bebd0032-c10e-4b58-9d92-e9c5476bb88b","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"=audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"}]},"options":{}},"id":"5fd0ba30-59d0-4d36-b5a2-e6769fee78e4","name":"Switch3","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-512,1696]},{"parameters":{"operation":"binaryToPropery","options":{}},"id":"f9d7b50d-50e0-487c-902e-3f25e573b5ac","name":"Audio-Base64-Extract from File","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[512,2448]},{"parameters":{"content":"# Resposta em √Åudio","height":80,"width":376,"color":5},"id":"20c9d9fd-a47c-46ed-82ec-ddf8d4e6e8d1","name":"Sticky Note25","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-32,2272]},{"parameters":{"jsCode":"// Obt√©m o primeiro item do fluxo\nconst item = $input.first();\n\n// Garante que h√° dados na entrada\nif (!item || !item.json || !$('When Executed by Another Workflow').first().json.output) {\n  throw new Error(\"A chave 'output' n√£o foi encontrada no JSON de entrada.\");\n}\n\n// Processa o texto removendo todas as quebras de linha e emojis\nconst textoEntrada = $('When Executed by Another Workflow').first().json.output; // Use a chave correta para pegar o texto de entrada\n\n// Remove quebras de linha (\\n)\nlet textoProcessado = textoEntrada.replace(/\\n/g, \"\");\n\n// Remove emojis\ntextoProcessado = textoProcessado.replace(\n  /[\\u{1F600}-\\u{1F64F}]|[\\u{1F300}-\\u{1F5FF}]|[\\u{1F680}-\\u{1F6FF}]|[\\u{1F700}-\\u{1F77F}]|[\\u{1F780}-\\u{1F7FF}]|[\\u{1F800}-\\u{1F8FF}]|[\\u{1F900}-\\u{1F9FF}]|[\\u{1FA00}-\\u{1FA6F}]|[\\u{1FA70}-\\u{1FAFF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]|[\\u{FE00}-\\u{FE0F}]|[\\u{1F1E0}-\\u{1F1FF}]/gu,\n  \"\"\n);\n\n// Retorna o resultado\nreturn {\n  textoOriginal: textoEntrada,\n  textoSemQuebrasNemEmojis: textoProcessado,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[112,2448],"id":"36f69c29-8ab6-4e73-96cc-db3b1386c9c9","name":"Formata Mensagem para √Åudio"},{"parameters":{"workflowInputs":{"values":[{"name":"messageType"},{"name":"telefone"},{"name":"output"},{"name":"session_id"},{"name":"id_message"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-2320,1536],"id":"803ec6f4-b20d-4dcf-88a6-dad30483259f","name":"When Executed by Another Workflow"},{"parameters":{"options":{}},"id":"abea9a2f-80c3-4202-baa8-8a4e274da742","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-976,720]},{"parameters":{"amount":2},"id":"00cdbad2-ee74-46e5-8a65-b12b0451a500","name":"Wait1","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1296,592],"webhookId":"069143e9-1ca0-42d0-ae36-a57c428d8cba"},{"parameters":{"assignments":{"assignments":[{"id":"e5658d52-0569-4cdf-8d18-39008eeabd2d","name":"status","value":"success","type":"string"}]},"options":{}},"id":"16e7e79e-8d8c-4fb9-8441-37d6dbd0a33c","name":"retornar sucesso1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[192,96],"executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ae76fc1f-0806-4811-b7df-da9f7aca756a","leftValue":"={{ $json.content }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"1cc1cb27-ecb4-41e8-bcd6-df169612badd","name":"Filter","type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-1216,720]},{"parameters":{"jsCode":"// pega a sa√≠da do n√≥ anterior\nconst text = $('When Executed by Another Workflow').first().json.output;\nconst result = [];\nlet messageCounter = 1; // Contador para as mensagens\n\n// 1) Separa em ‚Äúse√ß√µes‚Äù por dupla quebra de linha\nconst sections = text.split(/\\n\\s*\\n/);\n\nsections.forEach(section => {\n  const lines = section.split('\\n');\n  let buffer = [];\n\n  lines.forEach(line => {\n    // detecta imagem (markdown com {type})\n    const imageMatch = line.match(/!\\[(.*?)\\]\\((.*?)\\)\\{(.*?)\\}/);\n    if (imageMatch) {\n      // processa texto acumulado antes da imagem\n      if (buffer.length) {\n        processText(buffer.join('\\n').trim());\n        buffer = [];\n      }\n      result.push({\n        type: imageMatch[3],\n        description: imageMatch[1],\n        content: imageMatch[2]\n      });\n    } else {\n      buffer.push(line);\n    }\n  });\n\n  // processa o que sobrou no buffer dessa se√ß√£o\n  if (buffer.length) {\n    processText(buffer.join('\\n').trim());\n  }\n});\n\n\n// 2) Se todo bloco for s√≥ linhas de hor√°rio (HH:MM), envia tudo junto\nfunction processText(textBlock) {\n  const lines = textBlock.split('\\n').map(l => l.trim());\n  const allHaveTime = lines.length > 1 && lines.every(l => /\\d{2}:\\d{2}/.test(l));\n  if (allHaveTime) {\n    result.push({\n      type: \"text\",\n      description: \"text\",\n      content: lines.join('\\n')\n    });\n    return;\n  }\n  // sen√£o, quebra em frases pela pontua√ß√£o\n  finalizeText(textBlock);\n}\n\n\n// 3) fatiamento ‚Äúnormal‚Äù de texto: quebra em [? ! ; :] mas n√£o entre d√≠gitos (evita fatiar ‚Äú09:00‚Äù)\nfunction finalizeText(text) {\n  const regex = /(?<!\\d)([?!])(?!\\d|\\s*[\\p{Emoji_Presentation}\\p{Extended_Pictographic}])/gu;\n  let parts = [],\n    lastIndex = 0;\n\n  for (const m of text.matchAll(regex)) {\n    const idx = m.index + 1;\n    parts.push(text.slice(lastIndex, idx).trim());\n    lastIndex = idx;\n  }\n  if (lastIndex < text.length) {\n    parts.push(text.slice(lastIndex).trim());\n  }\n\n  parts.forEach(fragment => {\n    if (fragment) {\n      result.push({\n        type: \"text\",\n        description: \"text\",\n        content: fragment,\n        number: messageCounter++ // Adiciona o n√∫mero como uma propriedade 'number'\n      });\n    }\n  });\n}\n\n\n// retorna o array pronto\nreturn result;"},"id":"bfa7c091-499c-49d7-abb4-079ae6e27315","name":"Code","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1424,720]},{"parameters":{"content":"","height":344,"width":956,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1728,560],"typeVersion":1,"id":"c4b3a995-b91d-4069-aea0-335a47b60136","name":"Sticky Note"},{"parameters":{"content":"## Recebe a mensagem da IA e Divide ela","height":80,"width":560,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1712,576],"typeVersion":1,"id":"e90fa2dd-0089-4c1b-a661-61aeb825a033","name":"Sticky Note1"},{"parameters":{"content":"# Identificar a resposta da IA","height":400,"width":400},"type":"n8n-nodes-base.stickyNote","position":[-656,1552],"typeVersion":1,"id":"3830d663-b448-4a34-a7ad-62041f47bf8b","name":"Sticky Note2"},{"parameters":{"content":"# Responder em Imagem","height":400,"width":728,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-48,1824],"typeVersion":1,"id":"9dc15f8a-d48f-4dbc-99ec-e68a211a4083","name":"Sticky Note26"},{"parameters":{"content":"# Responder em Texto Marcado","height":400,"width":728,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-48,1392],"typeVersion":1,"id":"f182ff66-c350-4007-8885-8141fd35d6dc","name":"Sticky Note27"},{"parameters":{"resource":"messages-api","remoteJid":"={{ $('When Executed by Another Workflow').first().json.telefone }}","messageText":"={{ $('Loop Over Items').first().json.content }}","options_message":{"quoted":{"messageQuoted":{"messageId":"={{ $('When Executed by Another Workflow').item.json.id_message }}"}}}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1632,1424],"id":"ff2cb4dc-2252-4ddf-a6e8-46cc11637636","name":"Enviar texto","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}}},{"parameters":{"options_Create_instance":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[224,1984],"id":"4ce4fa6b-1f19-48bb-81b4-d95e317591ca","name":"Enviar imagem","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b1b526d1-3225-4a44-bf44-7c21a9131d89","leftValue":"={{ $('Filter').item.json.number }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[16,1056],"id":"d7ebe71d-9b02-418d-a25d-153587ce81af","name":"If"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"0985904e-7d4e-4fba-ae26-2c44200855e1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"52aaf749-fe4f-44e4-880e-15b2bfc027f1","leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"chat","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('When Executed by Another Workflow').item.json.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"e3e43b4d-d2a5-4418-986a-f7f80ec935b9"}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"}]},"options":{}},"id":"e9e1d6b7-0158-43af-87a5-ab83e3b76967","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3,"position":[304,1056]},{"parameters":{"resource":"messages-api","instanceName":"eduardaqr","remoteJid":"={{ $('When Executed by Another Workflow').first().json.telefone }}","messageText":"={{ $('Loop Over Items').first().json.content }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1632,1264],"id":"bd91be5e-78ff-4cc1-afc9-1336e0aba639","name":"Enviar texto1","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}}},{"parameters":{"content":"# Responder sem Marca√ß√£o","height":416,"width":940,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-48,944],"typeVersion":1,"id":"a96236a7-1bfb-44a4-a916-371134217c11","name":"Sticky Note28"},{"parameters":{"resource":"messages-api","operation":"send-audio","remoteJid":"={{ $('When Executed by Another Workflow').item.json.telefone }}","media":"={{ $json.data }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[704,2448],"id":"7f1f2158-9fd2-4b7d-b9f3-9b917c66e1da","name":"Enviar audio","credentials":{"evolutionApi":{"id":"rVCPNltywu7cWAFR","name":"Evolution account"}},"disabled":true},{"parameters":{"content":"","height":416,"width":972,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-48,2256],"typeVersion":1,"id":"8d208b7c-2e7f-45da-81fb-8fd3c6bfec01","name":"Sticky Note29"},{"parameters":{"content":"# MENSAGEM ENVIADAS","height":304,"width":496,"color":4},"type":"n8n-nodes-base.stickyNote","position":[0,0],"typeVersion":1,"id":"2fa55214-ca58-49cf-8df7-04bcc292e34d","name":"Sticky Note3"},{"parameters":{"resource":"audio","model":"tts-1-hd","input":"={{ $json.textoSemQuebrasNemEmojis }}","voice":"echo","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[304,2448],"id":"573696b1-a9f9-484b-8e65-aa8250811f6d","name":"Generate audio","credentials":{"openAiApi":{"id":"CTMpiiF2zxl00KmT","name":"OpenAi account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-192,800],"id":"722614a5-2052-48c0-97b0-009e95f03d20","name":"No Operation, do nothing"},{"parameters":{"operation":"get","propertyName":"block","key":"={{ $('When Executed by Another Workflow').item.json.telefone }}_block","options":{}},"id":"52ac039a-49ab-4fa3-b43c-da483253729c","name":"Verifica Atendimento Humano1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-688,960],"credentials":{"redis":{"id":"7HCG3WpFnYjB2DIT","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.block }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Ativa"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3ef0e01c-cc14-4663-bb4d-2905b350c3ab","leftValue":"={{ $json.block }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Desativada"}]},"options":{}},"id":"ff2d32d6-83ca-4d6f-941c-5fea54ad44cf","name":"Switch Block","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-448,960]},{"parameters":{"resource":"Chatting","operation":"Send Text","session":"=DraEduarda","chatId":"={{ $('When Executed by Another Workflow').first().json.telefone }}","reply_to":"={{ $('When Executed by Another Workflow').first().json.id_message }}","text":"={{ $('Loop Over Items').first().json.content }}","linkPreview":false,"requestOptions":{}},"type":"@devlikeapro/n8n-nodes-waha.WAHA","typeVersion":202502,"position":[208,1520],"id":"2c5e17b2-1f53-41d4-81d3-fec5797d24a4","name":"Send a text message","credentials":{"wahaApi":{"id":"7N6Qnba8NbZLvCTo","name":"WAHA - MEDMASTERS"}},"onError":"continueErrorOutput"},{"parameters":{"resource":"Chatting","operation":"Send Text","session":"=DraEduarda","chatId":"={{ $('When Executed by Another Workflow').first().json.telefone }}","reply_to":"=","text":"={{ $('Loop Over Items').first().json.content }}","linkPreview":false,"requestOptions":{}},"type":"@devlikeapro/n8n-nodes-waha.WAHA","typeVersion":202502,"position":[608,1072],"id":"cfa70ac9-966a-420b-9ac4-2ed6b49dbd88","name":"Send a text message1","credentials":{"wahaApi":{"id":"7N6Qnba8NbZLvCTo","name":"WAHA - MEDMASTERS"}},"onError":"continueErrorOutput"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[480,1584],"id":"fb390e2d-b015-416c-975d-46f893a1df74","name":"Wait","webhookId":"9cb7c3c4-0421-4186-9fae-09ed1cb0f475"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[752,1184],"id":"3385c517-7d80-4814-b577-6442c12bd94f","name":"Wait2","webhookId":"9cb7c3c4-0421-4186-9fae-09ed1cb0f475"}],"connections":{"Switch3":{"main":[[{"node":"Enviar imagem","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}]]},"Audio-Base64-Extract from File":{"main":[[{"node":"Enviar audio","type":"main","index":0}]]},"Formata Mensagem para √Åudio":{"main":[[{"node":"Generate audio","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[]]},"Loop Over Items":{"main":[[{"node":"retornar sucesso1","type":"main","index":0}],[{"node":"Verifica Atendimento Humano1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Code":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Enviar texto":{"main":[[]]},"Enviar imagem":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"If":{"main":[[{"node":"Switch3","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[],[{"node":"Send a text message1","type":"main","index":0}],[{"node":"Send a text message1","type":"main","index":0}]]},"Enviar texto1":{"main":[[]]},"Enviar audio":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Generate audio":{"main":[[{"node":"Audio-Base64-Extract from File","type":"main","index":0}]]},"Verifica Atendimento Humano1":{"main":[[{"node":"Switch Block","type":"main","index":0}]]},"Switch Block":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Send a text message1":{"main":[[{"node":"Wait1","type":"main","index":0}],[{"node":"Wait2","type":"main","index":0}]]},"Send a text message":{"main":[[{"node":"Wait1","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Send a text message","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"Send a text message1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"messageType":"chat","telefone":"5519991679072","output":"Ol√°, Guilherme! Bom dia! üëã  \n\nSou da cl√≠nica da Dra. Eduarda Costa, m√©dica cirurgi√£ vascular e angiologista. Para te ajudar da melhor forma, me conta: qual √© sua principal d√∫vida ou queixa no momento?","session_id":"2c3e9547-90d3-4c4e-8a6d-7896bf2eb9a9","id_message":"2AB60EA0D29FB2F1BCA9"}}]},"versionId":"e7d4402a-7e18-40f9-ad52-e365b7d83bed","triggerCount":0,"shared":[{"createdAt":"2025-10-14T11:41:01.289Z","updatedAt":"2025-10-14T11:41:01.289Z","role":"workflow:owner","workflowId":"0rAX0nOXworwsX6I","projectId":"E1RXJ9dhy40aA4CQ"}],"tags":[]}