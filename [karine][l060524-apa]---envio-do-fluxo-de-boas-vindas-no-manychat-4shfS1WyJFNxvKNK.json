{"createdAt":"2025-06-03T13:56:47.890Z","updatedAt":"2025-06-03T13:56:54.068Z","id":"4shfS1WyJFNxvKNK","name":"[KARINE][L060524-APA] - Envio do fluxo de boas vindas no Manychat","active":false,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.manychat.com/fb/subscriber/createSubscriber","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"=Bearer 1746222495610114:98411c837cea31efbec616a060b6ed72"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"first_name","value":"={{ $node[\"formata_dados\"].json[\"fullname\"].split(' ')[0] }}"},{"name":"last_name","value":"={{ $node[\"formata_dados\"].json[\"fullname\"].split(' ').slice(1).join(\" \") || \".\" }}"},{"name":"has_opt_in_sms","value":"true"},{"name":"has_opt_in_email","value":"true"},{"name":"consent_phrase","value":"Olá, aqui é a Karine Waldrich. Posso ter seu contato?"},{"name":"phone","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}"},{"name":"email","value":"={{ $node[\"formata_dados\"].json[\"email\"] }}"},{"name":"whatsapp_phone","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}"}]},"options":{}},"id":"3ee928cc-78d3-47e3-93b5-c23103136da4","name":"cria_contato_manychat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[40,-100],"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"https://api.manychat.com/fb/sending/sendFlow","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"=Bearer 1746222495610114:98411c837cea31efbec616a060b6ed72"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"flow_ns","value":"=content20240503014100_126848"},{"name":"subscriber_id","value":"={{\n  $node[\"cria_contato_manychat\"].runIndex >= 0 \n    ? $node[\"cria_contato_manychat\"].json[\"data\"][\"id\"]\n    : $node[\"procura_id_manychat_pelo_email\"].runIndex >= 0 \n      ? $node[\"procura_id_manychat_pelo_email\"].json[\"data\"][\"id\"]    : $node[\"procura_id_manychat_pelo_telefone\"].runIndex >= 0 \n      ? $node[\"procura_id_manychat_pelo_telefone\"].json[\"data\"][\"id\"]\n\n              : null\n}}"}]},"options":{}},"id":"41b7845f-ce6e-453c-bf94-be203b9f2836","name":"envia_fluxo_boas_vindas","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[840,140]},{"parameters":{"queue":"=L060524 - PIPEDRIVE","options":{"arguments":{"argument":[{"key":"x-queue-type","value":"quorum"}]},"durable":true}},"id":"93c20b55-494f-42fa-819e-1fa18abbabec","name":"entra_na_fila","type":"n8n-nodes-base.rabbitmq","typeVersion":1,"position":[1280,140]},{"parameters":{"assignments":{"assignments":[{"id":"14c7cf63-22bf-44fa-b6f4-92a186c939ce","name":"Name","value":"={{ $node[\"formata_dados\"].json[\"fname\"] }}","type":"string"},{"id":"91410666-07d9-4fcc-a1cb-51b793716829","name":"Last name","value":"={{ $node[\"formata_dados\"].json[\"lname\"] }}","type":"string"},{"id":"b70c4f75-ee1c-4be2-8225-d59f9edef4ff","name":"Full name","value":"={{ $node[\"formata_dados\"].json[\"fullname\"] }}","type":"string"},{"id":"8ec8d02e-076a-4c60-a798-ffb7c526d493","name":"Email","value":"={{ $node[\"formata_dados\"].json[\"email\"] }}","type":"string"},{"id":"08771d5c-6ad1-4bc0-b61a-a33aafc07cc2","name":"Whatsapp","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}","type":"string"},{"id":"72ac37dd-c05e-4903-88e4-9a3d946ca1b4","name":"utm_source","value":"={{ $node[\"formata_dados\"].json[\"utm_source\"] }}","type":"string"},{"id":"9e74bbfc-1cf6-4641-944d-f07cf230c6f3","name":"utm_campaign","value":"={{ $node[\"formata_dados\"].json[\"utm_campaign\"] }}","type":"string"},{"id":"af0687a9-8a3f-488a-970b-0f93c9bc6666","name":"utm_term","value":"={{ $node[\"formata_dados\"].json[\"utm_term\"] }}","type":"string"},{"id":"7b4abc02-881a-4999-92d7-01fd86f4faf3","name":"utm_medium","value":"={{ $node[\"formata_dados\"].json[\"utm_medium\"] }}","type":"string"},{"id":"04c2de88-a0e6-42d6-9c58-dcb5f80bc29f","name":"utm_content","value":"={{ $node[\"formata_dados\"].json[\"utm_content\"] }}","type":"string"},{"id":"5fe973d1-d062-447c-9586-a18d76d4a62e","name":"data do cadastro","value":"={{ $now.format(\"yyyy-MM-dd HH:mm:ss\") }}","type":"string"}]},"options":{}},"id":"3ec162ca-abd4-4922-be98-a9b8b451dcc7","name":"Edit Fields","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[1060,140]},{"parameters":{"url":"https://api.manychat.com/fb/subscriber/findBySystemField","sendQuery":true,"queryParameters":{"parameters":[{"name":"phone","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Authorization","value":"=Bearer 1746222495610114:98411c837cea31efbec616a060b6ed72"}]},"options":{}},"id":"8c640eb2-81d6-47cd-8a94-18d7f2e3982f","name":"procura_id_manychat_pelo_telefone","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-880,340]},{"parameters":{"conditions":{"string":[{"value1":"={{ $node[\"procura_id_manychat_pelo_telefone\"].json[\"data\"] }}","operation":"isEmpty"}]}},"id":"ea810090-bee8-4194-b971-65bd9d567a0d","name":"nao_encontrou_telefone","type":"n8n-nodes-base.if","typeVersion":1,"position":[-680,340]},{"parameters":{"url":"https://api.manychat.com/fb/subscriber/findBySystemField","sendQuery":true,"queryParameters":{"parameters":[{"name":"email","value":"={{ $node[\"formata_dados\"].json[\"email\"] }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Authorization","value":"=Bearer 1746222495610114:98411c837cea31efbec616a060b6ed72"}]},"options":{}},"id":"23e612ca-dfd1-479f-8a0d-fe9800003cf6","name":"procura_id_manychat_pelo_email","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-480,100]},{"parameters":{"conditions":{"string":[{"value1":"={{ $node[\"procura_id_manychat_pelo_email\"].json[\"data\"] }}","operation":"isEmpty"}]}},"id":"c44a4438-d9bb-4acb-9483-0af1b9d28f0f","name":"nao_encontrou_email","type":"n8n-nodes-base.if","typeVersion":1,"position":[-240,100]},{"parameters":{"method":"POST","url":"https://api.manychat.com/fb/subscriber/updateSubscriber","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"=Bearer 1746222495610114:98411c837cea31efbec616a060b6ed72"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"first_name","value":"={{ $node[\"formata_dados\"].json[\"fullname\"].split(' ')[0] }}"},{"name":"last_name","value":"={{ $node[\"formata_dados\"].json[\"fullname\"].split(' ').slice(1).join(\" \") || \".\" }}"},{"name":"has_opt_in_sms","value":"true"},{"name":"has_opt_in_email","value":"true"},{"name":"consent_phrase","value":"Olá, aqui é a Karine Waldrich. Posso ter seu contato?"},{"name":"whatsapp_phone","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}"},{"name":"phone","value":"={{ $node[\"formata_dados\"].json[\"whatsapp\"] }}"},{"name":"email","value":"={{ $node[\"formata_dados\"].json[\"email\"] }}"},{"name":"subscriber_id","value":"={{\n  $node[\"cria_contato_manychat\"].runIndex >= 0 \n    ? $node[\"cria_contato_manychat\"].json[\"data\"][\"id\"]\n    : $node[\"procura_id_manychat_pelo_email\"].runIndex >= 0 \n      ? $node[\"procura_id_manychat_pelo_email\"].json[\"data\"][\"id\"]    : $node[\"procura_id_manychat_pelo_telefone\"].runIndex >= 0 \n      ? $node[\"procura_id_manychat_pelo_telefone\"].json[\"data\"][\"id\"]\n\n              : null\n}}"}]},"options":{}},"id":"f0206817-c4da-41f5-8d3b-f307e44b599f","name":"atualiza_contato_manychat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[220,360],"continueOnFail":true},{"parameters":{"conditions":{"string":[{"value1":"={{ $json[\"error\"][\"message\"] }}","operation":"contains","value2":"This email address already exists"},{"value1":"={{ $json[\"data\"][\"id\"] }}","operation":"isNotEmpty"}]},"combineOperation":"any"},"id":"a34dee90-834e-4c0b-843a-5e46a3745c99","name":"erro_de_email","type":"n8n-nodes-base.if","typeVersion":1,"position":[500,360]},{"parameters":{"errorMessage":"An error ocurred!"},"id":"1b014238-cacf-433e-9373-d6d1ee988ae1","name":"Stop and Error","type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[840,540]},{"parameters":{"jsCode":"const fullNameAnswer = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[first_name]\"] || \"\";\nconst emailAnswer = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[email]\"] || \"\";\nconst telefoneClienteOriginal = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[phone]\"] || \"\";\n\nfunction capitalizeName(fullName) {\n    if (typeof fullName === 'undefined') {\n        return { fname: '', lname: '', fullname: '' };\n    }\n\n    const lowerCaseWords = ['da', 'de', 'do', 'di', 'du'];\n    let words = fullName.toLowerCase().split(' ').map((word, index) => {\n        if (lowerCaseWords.includes(word) && index !== 0) {\n            return word;\n        }\n        return word.charAt(0).toUpperCase() + word.slice(1);\n    });\n\n    let fname = words.shift();\n    let lname = words.join(' ');\n\n    return { fname, lname, fullname: fname + ' ' + lname };\n}\n\nfunction formatEmail(email) {\n    return email.toLowerCase().trim();\n}\n\n  const telefoneLimpo = telefoneClienteOriginal.replace(/\\D/g, \"\");\n  const DDI = '55';\n  const DDD = telefoneLimpo.slice(0, 2); // Correção: Extrair os primeiros dois dígitos para obter o DDD\n\n  // Determinar o número de telefone final\n  if (parseInt(DDD) > 28) {\n    telefoneFinal = `${DDI}${DDD}${telefoneLimpo.slice(-9)}`;\n  } else {\n    telefoneFinal = `${DDI}${DDD}${telefoneLimpo.slice(-9)}`;\n  }\n\n\nconst formattedNames = capitalizeName(fullNameAnswer);\nconst formattedEmail = formatEmail(emailAnswer);\nconst utm_source = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[fields][utm_source]\"] || \"\";\nconst utm_campaign = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[fields][utm_campaign]\"] || \"\";\nconst utm_medium = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[fields][utm_medium]\"] || \"\";\nconst utm_term = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[fields][utm_term]\"] || \"\";\nconst utm_content = $node[\"cadastro_lead_active\"].json[\"body\"][\"contact[fields][utm_content]\"] || \"\";\n\nconst result = {\n    ...formattedNames, // Nome formatado\n    email: formattedEmail, // Email formatado\n    whatsapp: telefoneFinal, // WhatsApp formatado\n    utm_source: utm_source,\n    utm_campaign: utm_campaign,\n    utm_term: utm_term,\n    utm_medium: utm_medium,\n    utm_content: utm_content\n  \n};\n\n// Aqui estamos ajustando a estrutura do retorno para se adequar ao que o n8n espera\nreturn [{ json: result }];"},"id":"917598bb-bc76-40d9-8247-580a76d32609","name":"formata_dados","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1060,340]},{"parameters":{"httpMethod":"POST","path":"l060524-apa-cadastro","options":{}},"id":"cf061bf9-0096-445f-a80d-92d377c5d5c3","name":"cadastro_lead_active","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1280,340],"webhookId":"d186d087-e69d-46c4-a306-c4babf1f61a4"}],"connections":{"cria_contato_manychat":{"main":[[{"node":"atualiza_contato_manychat","type":"main","index":0}]]},"envia_fluxo_boas_vindas":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"entra_na_fila","type":"main","index":0}]]},"procura_id_manychat_pelo_telefone":{"main":[[{"node":"nao_encontrou_telefone","type":"main","index":0}]]},"nao_encontrou_telefone":{"main":[[{"node":"procura_id_manychat_pelo_email","type":"main","index":0}],[{"node":"atualiza_contato_manychat","type":"main","index":0}]]},"procura_id_manychat_pelo_email":{"main":[[{"node":"nao_encontrou_email","type":"main","index":0}]]},"nao_encontrou_email":{"main":[[{"node":"cria_contato_manychat","type":"main","index":0}],[{"node":"atualiza_contato_manychat","type":"main","index":0}]]},"atualiza_contato_manychat":{"main":[[{"node":"erro_de_email","type":"main","index":0}]]},"erro_de_email":{"main":[[{"node":"envia_fluxo_boas_vindas","type":"main","index":0}],[{"node":"Stop and Error","type":"main","index":0}]]},"formata_dados":{"main":[[{"node":"procura_id_manychat_pelo_telefone","type":"main","index":0}]]},"cadastro_lead_active":{"main":[[{"node":"formata_dados","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"26f8b10e-eac6-4656-8c19-9cc839ec3a79","triggerCount":0,"shared":[{"createdAt":"2025-06-03T13:56:47.890Z","updatedAt":"2025-06-03T13:56:47.890Z","role":"workflow:owner","workflowId":"4shfS1WyJFNxvKNK","projectId":"E1RXJ9dhy40aA4CQ"}],"tags":[]}